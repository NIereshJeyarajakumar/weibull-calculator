<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Weibull Analysis Tool</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  max-width: 950px;
  margin: 30px auto;
  color: #000000;
}
.card {
  background: transparent;
  border: none;
  border-radius: 0;
  padding: 18px;
  margin: 12px 0;
}
textarea {
  width: 100%;
  min-height: 80px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  padding: 8px;
  background: transparent;
  color: #000000;
}
button {
  background: #C2965B;
  color: #000000;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 700;
}
.tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}
.tabs button {
  background: #C2965B;
  color: #000000;
  border: none;
  border-radius: 999px;
  padding: 8px 14px;
  font-weight: 700;
  cursor: pointer;
}
.tabs button.active {
  background: #000000;
  color: #ffffff;
}
canvas { display: none; }
#exportBtn {
  background: #C2965B;
  color: #000000;
  margin-top: 10px;
}
input[type="number"] {
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  padding: 6px;
  color: #000000;
  background: transparent;
}
.plot-title {
  font-weight: 700;
  margin: 10px 0 5px;
  text-align: center;
  font-size: 16px;
  color: #000000;
}
</style>
</head>
<body>

<div class="card">
  <label>Failure times</label>
  <textarea id="fail" placeholder="Enter failure times separated by commas or spaces"></textarea>
  <label>Suspensions (optional)</label>
  <textarea id="susp" placeholder="Enter suspension times (optional)"></textarea>
  <div style="margin-top:10px">
    <label><input type="radio" name="m" value="rroy" checked> Rank Regression on Y</label>
    <label><input type="radio" name="m" value="rrox"> Rank Regression on X</label>
    <label><input type="radio" name="m" value="mle"> Maximum Likelihood Estimation</label>
  </div>
  <div style="margin-top:12px">
    <button id="run">Calculate</button>
    <span id="msg" style="margin-left:8px;color:#000000"></span>
  </div>
</div>

<div class="card">
  <h3>Results</h3>
  <div id="out"></div>
</div>

<div class="card" id="reliabilityCard" style="display:none">
  <h3>Reliability at Specific Time</h3>
  <label>Enter time (same units as input data):</label>
  <input type="number" id="timeInput" style="width:120px;margin-left:10px">
  <button id="calcRel">Calculate Reliability</button>
  <div id="relOut" style="margin-top:10px;font-weight:600"></div>
</div>

<div class="card">
  <h3>Plots</h3>
  <div class="tabs">
    <button data-target="pdf" class="active">PDF</button>
    <button data-target="cdf">CDF</button>
    <button data-target="rel">Reliability</button>
    <button data-target="haz">Hazard</button>
    <button data-target="weibplot">Weibull Probability Plot</button>
  </div>

  <div class="plot-title" id="pdf-title">Probability Density Function (PDF)</div>
  <canvas id="pdf" height="260"></canvas>

  <div class="plot-title" id="cdf-title">Cumulative Distribution Function (CDF)</div>
  <canvas id="cdf" height="260"></canvas>

  <div class="plot-title" id="rel-title">Reliability Function</div>
  <canvas id="rel" height="260"></canvas>

  <div class="plot-title" id="haz-title">Hazard Rate Function</div>
  <canvas id="haz" height="260"></canvas>

  <div class="plot-title" id="weibplot-title">Weibull Probability Plot</div>
  <canvas id="weibplot" height="480"></canvas>

  <button id="exportBtn">Download Plot</button>
</div>

<script>
const byId=id=>document.getElementById(id);
const parseNums=s=>(s||"").split(/[\s,]+/).map(Number).filter(v=>isFinite(v)&&v>0).sort((a,b)=>a-b);
const Fm=n=>Array.from({length:n},(_,i)=>(i+1-0.3)/(n+0.4));
function destroyChart(id){const c=byId(id),ex=Chart.getChart(c);if(ex)ex.destroy();}
function linReg(X,Y){const n=X.length;let sx=0,sy=0,sxx=0,sxy=0;
  for(let i=0;i<n;i++){sx+=X[i];sy+=Y[i];sxx+=X[i]*X[i];sxy+=X[i]*Y[i];}
  const b=(n*sxy-sx*sy)/(n*sxx-sx*sx),a=(sy-b*sx)/n;return{a,b};
}
function rrY(f){const n=f.length,F=Fm(n),X=f.map(t=>Math.log(t)),Y=F.map(Fi=>Math.log(-Math.log(1-Fi)));
  const {a,b}=linReg(X,Y);return{m:"Rank Regression on Y",beta:b,eta:Math.exp(-a/b)};}
function rrX(f){const n=f.length,F=Fm(n),X=F.map(Fi=>Math.log(-Math.log(1-Fi))),Y=f.map(t=>Math.log(t));
  const {a,b}=linReg(X,Y);return{m:"Rank Regression on X",beta:1/b,eta:Math.exp(a)};}
function mle(f,c){const r=f.length,all=f.concat(c||[]),sumLn=f.reduce((s,t)=>s+Math.log(t),0);
  function sums(b){let C=0,B=0,B2=0,C1=0;for(const t of all){const lt=Math.log(t),tb=t**b;C+=tb;B+=tb*lt;B2+=tb*lt*lt;C1+=tb*lt;}return{C,B,B2,C1};}
  function g(b){const{C,B}=sums(b);return r/b+sumLn-r*(B/C);}
  function g1(b){const{C,B,B2,C1}=sums(b);const d=(B2*C-B*C1)/(C*C);return -r/(b*b)-r*d;}
  let b0=(()=>{try{return rrY(f).beta;}catch{return 1.5;}})();
  for(let i=0;i<80;i++){const gb=g(b0),gp=g1(b0);if(!isFinite(gb)||!isFinite(gp)||gp===0)break;
    const next=b0-gb/gp;if(Math.abs(next-b0)<1e-8*Math.max(1,b0)){b0=next;break;}
    b0=Math.min(Math.max(next,0.1),50);}
  const C=all.reduce((s,t)=>s+t**b0,0),eta=(C/r)**(1/b0);
  return{m:"MLE",beta:b0,eta};
}
function FtoY(F){return Math.log(-Math.log(1-F));}
function gamma(x){let g=7,p=[0.99999999999980993,676.5203681218851,-1259.1392167224028,771.32342877765313,-176.61502916214059,12.507343278686905,-0.13857109526572012,9.9843695780195716e-6,1.5056327351493116e-7];
  if(x<0.5)return Math.PI/Math.sin(Math.PI*x)/gamma(1-x);
  x-=1;let a=p[0],t=x+g+0.5;for(let i=1;i<g+2;i++)a+=p[i]/(x+i);
  return Math.sqrt(2*Math.PI)*Math.pow(t,x+0.5)*Math.exp(-t)*a;
}
// Anderson–Darling for Weibull
function andersonDarlingWeibull(f,beta,eta){
  const n=f.length;if(n<2)return NaN;
  const z=f.map(t=>1-Math.exp(-Math.pow(t/eta,beta))).sort((a,b)=>a-b);
  let sum=0;for(let i=0;i<n;i++){sum+=(2*(i+1)-1)*(Math.log(z[i])+Math.log(1-z[n-i-1]));}
  const A2=-n - sum/n;return A2*(1+0.6/n);
}

let charts={}, lastParams=null;

function draw(id,label,x,y){
  destroyChart(id);
  const ctx=byId(id).getContext("2d");
  charts[id]=new Chart(ctx,{
    type:"line",
    data:{labels:x,datasets:[{label,data:y,borderWidth:2,fill:false,tension:.1,borderColor:"#000000"}]},
    options:{
      responsive:true,
      animation:false,
      plugins:{legend:{display:false},title:{display:true,text:label,font:{size:14}}},
      scales:{
        x:{title:{display:true,text:"Time"},ticks:{callback:(v)=>Number(v).toFixed(0)},grid:{color:'#ddd'}},
        y:{title:{display:true,text:label}}
      }
    }
  });
}

function weibullPlot(f,beta,eta){
  const Fmin=0.05,Fmax=0.99;
  const tmin=eta*Math.pow(-Math.log(1-Fmin),1/beta);
  const tmax=eta*Math.pow(-Math.log(1-Fmax),1/beta);
  const n=f.length,F=Fm(n);
  const pts=f.map((t,i)=>({x:t,y:FtoY(F[i])}));

  const line=[];
  for(let t=tmin;t<=tmax;t*=1.02){ line.push({x:t,y:beta*Math.log(t)-beta*Math.log(eta)}); }

  // vertical η line across full Y-range, styled in #C2965B
  const etaLine=[{x:eta,y:FtoY(0.05)},{x:eta,y:FtoY(0.99)}];

  const Fy=[0.05,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,0.99];
  const Yticks=Fy.map(v=>({value:FtoY(v),label:(v*100).toFixed(0)}));

  destroyChart("weibplot");
  const ctx=byId("weibplot").getContext("2d");
  charts.weibplot=new Chart(ctx,{
    type:"scatter",
    data:{
      datasets:[
        {label:"Data",data:pts,backgroundColor:"#000000"},
        {label:"Fit",data:line,type:"line",borderColor:"#2b6cb0",borderWidth:2,fill:false,pointRadius:0},
        {label:"η (63.2%)",data:etaLine,type:"line",borderColor:"#C2965B",borderWidth:2,borderDash:[6,6],pointRadius:0}
      ]
    },
    options:{
      responsive:true,animation:false,parsing:false,
      plugins:{legend:{display:false},title:{display:true,text:`Weibull Probability Plot — η=${eta.toFixed(2)}, β=${beta.toFixed(3)}`}},
      scales:{
        x:{type:"logarithmic",title:{display:true,text:"Time (log scale)"},min:tmin,max:tmax,
           ticks:{callback:(v)=>Number(v).toLocaleString()},grid:{color:'#ddd'}},
        y:{title:{display:true,text:"Unreliability F(t) (%)"},min:FtoY(0.05),max:FtoY(0.99),
           afterBuildTicks:(axis)=>{axis.ticks=Yticks.map(t=>({value:t.value,label:t.label}));},
           ticks:{callback:(val)=>{const t=Yticks.find(tt=>Math.abs(tt.value-val)<0.05);return t?t.label:"";}},
           grid:{color:(ctx)=>Yticks.some(t=>Math.abs(t.value-ctx.tick.value)<0.05)?'#bbb':'#eee'}}
      }
    }
  });
}

const panels=["pdf","cdf","rel","haz","weibplot"];
function showPanel(id){
  panels.forEach(p=>{
    const el=byId(p);
    const titleEl=byId(`${p}-title`);
    el.style.display=(p===id)?"block":"none";
    titleEl.style.display=(p===id)?"block":"none";
    document.querySelector(`button[data-target="${p}"]`).classList.toggle("active",p===id);
    if(charts[p]){charts[p].resize();charts[p].update();}
  });
}

function exportChart(){
  const active=document.querySelector(".tabs button.active").dataset.target;
  const chart=charts[active];
  if(!chart){ alert("No chart available."); return; }
  const link=document.createElement("a");
  link.download=`${active}_plot.png`;
  link.href=chart.toBase64Image();
  link.click();
}

function calculateReliability(){
  if(!lastParams)return;
  const t=parseFloat(byId("timeInput").value);
  if(!isFinite(t)||t<=0){
    byId("relOut").textContent="⚠ Please enter a valid time value.";
    return;
  }
  const {beta,eta}=lastParams;
  const R=Math.exp(-Math.pow(t/eta,beta));
  const U=1-R;
  byId("relOut").innerHTML=`Reliability at <b>${t.toFixed(0)}</b> = <b>${(R*100).toFixed(2)}%</b><br>Unreliability = ${(U*100).toFixed(2)}%`;
}

function run(){
  try{
    byId("msg").textContent="";
    const f=parseNums(byId("fail").value),c=parseNums(byId("susp").value);
    const m=[...document.querySelectorAll('input[name="m"]')].find(r=>r.checked).value;
    if((m==="rroy"||m==="rrox")&&f.length<2)throw new Error("≥2 failures needed");
    if(m==="mle"&&f.length<1)throw new Error("≥1 failure needed");

    let r=(m==="rroy")?rrY(f):(m==="rrox")?rrX(f):mle(f,c);

    const totalPoints=f.length+c.length;
    let plotParams=(totalPoints<=15)?rrY(f):mle(f,c);

    const rrRes=r;
    const tmax=Math.max(...f.concat(c.length?c:[0]))*1.5;

    const {x,pdf,cdf,rel,haz}=(()=>{const n=200,X=[],pdf=[],cdf=[],rel=[],haz=[];
      for(let i=0;i<n;i++){
        const t=tmax*i*i/(n-1)**2;
        const z=(t/rrRes.eta)**rrRes.beta;
        const R=Math.exp(-z);
        const f1=(rrRes.beta/rrRes.eta)*(t/rrRes.eta)**(rrRes.beta-1)*Math.exp(-z);
        X.push(t);pdf.push(f1);cdf.push(1-R);rel.push(R);haz.push(f1/R);
      }
      return{x:X,pdf,cdf,rel,haz};
    })();

    draw("pdf","PDF",x,pdf);
    draw("cdf","CDF",x,cdf);
    draw("rel","Reliability",x,rel);
    draw("haz","Hazard",x,haz);
    weibullPlot(f,plotParams.beta,plotParams.eta);

    const mttf = rrRes.eta * gamma(1 + 1/rrRes.beta);
    const adStat = andersonDarlingWeibull(f, rrRes.beta, rrRes.eta);
    let fitQuality="N/A";
    if(!isNaN(adStat)){
      if(adStat < 0.3) fitQuality="Excellent fit";
      else if(adStat < 0.6) fitQuality="Good fit";
      else if(adStat < 1.0) fitQuality="Moderate fit";
      else fitQuality="Poor fit";
    }

    const rows=[
      ["Method",r.m],
      ["β (Shape)",r.beta.toFixed(6)],
      ["η (Scale)",r.eta.toFixed(6)],
      ["MTTF",mttf.toFixed(6)],
      ["Anderson–Darling A²", isNaN(adStat) ? "N/A" : adStat.toFixed(4)],
      ["Goodness of Fit",fitQuality]
    ];
    byId("out").innerHTML="<table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>"+
      rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("")+"</tbody></table>";

    lastParams=r;
    byId("reliabilityCard").style.display="block";
    byId("relOut").textContent="";
    showPanel(document.querySelector(".tabs button.active").dataset.target);
  }catch(e){byId("msg").textContent="⚠ "+(e?.message||e);}
}

document.addEventListener("DOMContentLoaded",()=>{
  byId("run").addEventListener("click",run);
  byId("exportBtn").addEventListener("click",exportChart);
  byId("calcRel").addEventListener("click",calculateReliability);
  document.querySelectorAll(".tabs button").forEach(btn=>btn.addEventListener("click",()=>showPanel(btn.dataset.target)));
  showPanel("pdf");
});
</script>
</body>
</html>
